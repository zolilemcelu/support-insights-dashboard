{% extends 'base.html.twig' %}
{% block title %}Support Reports{% endblock %}

{% block body %}
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.4; padding: 24px; }
  h1 { font-size: 32px; margin-bottom: 8px; }
  .kpis { margin: 8px 0 24px; font-size: 16px; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  table { border-collapse: collapse; min-width: 320px; }
  th, td { border: 1px solid #cfcfcf; padding: 8px 10px; text-align: left; }
  th { background: #f4f4f4; }
  .card { padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; }
  .filters { margin-bottom: 24px; display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
  .filters label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
  .filters input, .filters select { padding: 6px 8px; border: 1px solid #bbb; border-radius: 6px; }
  .filters button { padding: 8px 12px; border: 0; border-radius: 6px; background: #1f6feb; color: #fff; cursor: pointer; }
  .filters a { margin-left: 8px; }
  canvas { max-width: 100%; }
</style>

<h1>Support Reports</h1>

<div class="filters">
  <div>
    <label for="start">Start date</label>
    <input id="start" type="date" value="{{ filters.start }}">
  </div>
  <div>
    <label for="end">End date</label>
    <input id="end" type="date" value="{{ filters.end }}">
  </div>
  <div>
    <label for="product">Product</label>
    <select id="product">
      <option value="">All products</option>
      {% for p in products %}
        <option value="{{ p }}" {{ filters.product == p ? 'selected' : '' }}>{{ p }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <button id="apply">Apply</button>
    <a href="{{ path('support_reports') }}">Reset</a>
  </div>
</div>

<div class="kpis">
  Total: <strong>{{ kpis.total_queries|default(0) }}</strong>,
  FCR: <strong>{{ kpis.fcr_pct|default(0) }}%</strong>,
  Avg resolve: <strong>{{ kpis.avg_time_to_resolve|default('00:00:00') }}</strong>
</div>

<div class="grid">
  <div class="card">
    <h2>Category Split</h2>
    <table>
      <tr><th>Category</th><th>Total</th></tr>
      {% for r in categories %}
        <tr><td>{{ r.category ?: '—' }}</td><td>{{ r.total }}</td></tr>
      {% else %}
        <tr><td colspan="2">No data</td></tr>
      {% endfor %}
    </table>
  </div>

  <div class="card">
    <h2>Daily Trend</h2>
    <canvas id="trend" height="120"></canvas>
  </div>

  <div class="card">
    <h2>Top 10 Themes (Controllable)</h2>
    <table>
      <tr><th>Theme</th><th>Total</th></tr>
      {% for r in themes %}
        <tr><td>{{ r.complaint_theme ?: '—' }}</td><td>{{ r.total }}</td></tr>
      {% else %}
        <tr><td colspan="2">No data</td></tr>
      {% endfor %}
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Build URL with filters
  document.getElementById('apply').addEventListener('click', () => {
    const start = document.getElementById('start').value;
    const end   = document.getElementById('end').value;
    const prod  = document.getElementById('product').value;
    const params = new URLSearchParams();
    if (start) params.set('start', start);
    if (end)   params.set('end', end);
    if (prod)  params.set('product', prod);
    const url = '{{ path('support_reports') }}' + (params.toString() ? ('?' + params.toString()) : '');
    window.location.href = url;
  });

  const labels = {{ trend|map(t=>t.d)|json_encode|raw }};
  const data   = {{ trend|map(t=>t.total)|json_encode|raw }};
  new Chart(document.getElementById('trend'), {
    type: 'line',
    data: { labels, datasets: [{ label: 'Queries', data, tension: 0.3 }] },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
    }
  });
</script>
{% endblock %}
